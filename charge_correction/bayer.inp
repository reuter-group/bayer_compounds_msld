* CHARMM input file for Multi-Site lambda-dynamics
* generated by py_prep (JZV 02/2019) for ALF (RLH 01/2019)
*
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!  Multi-Site Lambda Dynamics 
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

set fnex = 5.5 
!!set sysname = bayer
set builddir = prep
set box = ????
set temp = 298.15
set ligseg = lig
set resnum = 1

! perturbation variables
set nsites = 1 
set nsubs1 = 10 
set nblocks = 10 

bomblev -2

!! Read in toppar stream file
stream @builddir/toppar.str

read rtf append card name @builddir/core.rtf
read param flex append card name @builddir/full_ligand.prm

!! !! Reads coordinates and pdb file for the protein
!! read sequ pdb name @builddir/protein.pdb
!! generate SEGID first NTER last CTER setup warn
!! read coor pdb resid name @builddir/protein.pdb
!! 
!! ic generate
!! ic param
!! ic build 
!! hbuild sele hydrogen end
!! auto angle dihe

!! Reads coordinates and pdb file for the ligand
read sequ pdb name @builddir/core.pdb
generate @ligseg setup
read coor pdb resid name @builddir/core.pdb

!! Read in the ligand patch rtf files
read rtf append card name @builddir/site1_sub1_pres.rtf
read rtf append card name @builddir/site1_sub2_pres.rtf
read rtf append card name @builddir/site1_sub3_pres.rtf
read rtf append card name @builddir/site1_sub4_pres.rtf
read rtf append card name @builddir/site1_sub5_pres.rtf
read rtf append card name @builddir/site1_sub6_pres.rtf
read rtf append card name @builddir/site1_sub7_pres.rtf
read rtf append card name @builddir/site1_sub8_pres.rtf
read rtf append card name @builddir/site1_sub9_pres.rtf
read rtf append card name @builddir/site1_sub10_pres.rtf

!! Read in the ligand fragment pdb files
ic generate

patch p1_1 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub1_frag.pdb
ic param
ic build

patch p1_2 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub2_frag.pdb
ic param
ic build

patch p1_3 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub3_frag.pdb
ic param
ic build

patch p1_4 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub4_frag.pdb
ic param
ic build

patch p1_5 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub5_frag.pdb
ic param
ic build

patch p1_6 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub6_frag.pdb
ic param
ic build

patch p1_7 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub7_frag.pdb
ic param
ic build

patch p1_8 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub8_frag.pdb
ic param
ic build

patch p1_9 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub9_frag.pdb
ic param
ic build

patch p1_10 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub10_frag.pdb
ic param
ic build

!! Read in LonePair sites (if applicable)
stream @builddir/lpsites.inp

!! Define MSLD substituent selections
define site1_sub1 - 
   select ( - 
   atom @ligseg @resnum N040 .or. -
   atom @ligseg @resnum N041 .or. -
   atom @ligseg @resnum C042 .or. -
   atom @ligseg @resnum H043 .or. -
   none ) end

define site1_sub2 - 
   select ( - 
   atom @ligseg @resnum N044 .or. -
   atom @ligseg @resnum N045 .or. -
   atom @ligseg @resnum C046 .or. -
   atom @ligseg @resnum N047 .or. -
   atom @ligseg @resnum H048 .or. -
   atom @ligseg @resnum H049 .or. -
   none ) end

define site1_sub3 - 
   select ( - 
   atom @ligseg @resnum N050 .or. -
   atom @ligseg @resnum N051 .or. -
   atom @ligseg @resnum C052 .or. -
   atom @ligseg @resnum O053 .or. -
   atom @ligseg @resnum C054 .or. -
   atom @ligseg @resnum H055 .or. -
   atom @ligseg @resnum H056 .or. -
   atom @ligseg @resnum H057 .or. -
   none ) end

define site1_sub4 - 
   select ( - 
   atom @ligseg @resnum N058 .or. -
   atom @ligseg @resnum N059 .or. -
   atom @ligseg @resnum C060 .or. -
   atom @ligseg @resnum N061 .or. -
   atom @ligseg @resnum H062 .or. -
   atom @ligseg @resnum C063 .or. -
   atom @ligseg @resnum H064 .or. -
   atom @ligseg @resnum H065 .or. -
   atom @ligseg @resnum H066 .or. -
   none ) end

define site1_sub5 - 
   select ( - 
   atom @ligseg @resnum N067 .or. -
   atom @ligseg @resnum N068 .or. -
   atom @ligseg @resnum C069 .or. -
   atom @ligseg @resnum N070 .or. -
   atom @ligseg @resnum H071 .or. -
   atom @ligseg @resnum C072 .or. -
   atom @ligseg @resnum C073 .or. -
   atom @ligseg @resnum H074 .or. -
   atom @ligseg @resnum C075 .or. -
   atom @ligseg @resnum H076 .or. -
   atom @ligseg @resnum H077 .or. -
   atom @ligseg @resnum C078 .or. -
   atom @ligseg @resnum H079 .or. -
   atom @ligseg @resnum H080 .or. -
   atom @ligseg @resnum O081 .or. -
   none ) end

define site1_sub6 - 
   select ( - 
   atom @ligseg @resnum N082 .or. -
   atom @ligseg @resnum N083 .or. -
   atom @ligseg @resnum C084 .or. -
   atom @ligseg @resnum N085 .or. -
   atom @ligseg @resnum H086 .or. -
   atom @ligseg @resnum C087 .or. -
   atom @ligseg @resnum O088 .or. -
   atom @ligseg @resnum C089 .or. -
   atom @ligseg @resnum H090 .or. -
   atom @ligseg @resnum H091 .or. -
   atom @ligseg @resnum H092 .or. -
   atom @ligseg @resnum O093 .or. -
   none ) end

define site1_sub7 - 
   select ( - 
   atom @ligseg @resnum N094 .or. -
   atom @ligseg @resnum N095 .or. -
   atom @ligseg @resnum C096 .or. -
   atom @ligseg @resnum N097 .or. -
   atom @ligseg @resnum H098 .or. -
   atom @ligseg @resnum C099 .or. -
   atom @ligseg @resnum O100 .or. -
   atom @ligseg @resnum N101 .or. -
   atom @ligseg @resnum H102 .or. -
   atom @ligseg @resnum C103 .or. -
   atom @ligseg @resnum H104 .or. -
   atom @ligseg @resnum H105 .or. -
   atom @ligseg @resnum H106 .or. -
   none ) end

define site1_sub8 - 
   select ( - 
   atom @ligseg @resnum N107 .or. -
   atom @ligseg @resnum N108 .or. -
   atom @ligseg @resnum C109 .or. -
   atom @ligseg @resnum N110 .or. -
   atom @ligseg @resnum H111 .or. -
   atom @ligseg @resnum S112 .or. -
   atom @ligseg @resnum O113 .or. -
   atom @ligseg @resnum O114 .or. -
   atom @ligseg @resnum C115 .or. -
   atom @ligseg @resnum H116 .or. -
   atom @ligseg @resnum H117 .or. -
   atom @ligseg @resnum H118 .or. -
   none ) end

define site1_sub9 - 
   select ( - 
   atom @ligseg @resnum N119 .or. -
   atom @ligseg @resnum N120 .or. -
   atom @ligseg @resnum C121 .or. -
   atom @ligseg @resnum S122 .or. -
   atom @ligseg @resnum N123 .or. -
   atom @ligseg @resnum H124 .or. -
   atom @ligseg @resnum C125 .or. -
   atom @ligseg @resnum H126 .or. -
   atom @ligseg @resnum H127 .or. -
   atom @ligseg @resnum H128 .or. -
   atom @ligseg @resnum O129 .or. -
   atom @ligseg @resnum O130 .or. -
   none ) end

define site1_sub10 - 
   select ( - 
   atom @ligseg @resnum N131 .or. -
   atom @ligseg @resnum N132 .or. -
   atom @ligseg @resnum C133 .or. -
   atom @ligseg @resnum N134 .or. -
   atom @ligseg @resnum H135 .or. -
   atom @ligseg @resnum C136 .or. -
   atom @ligseg @resnum C137 .or. -
   atom @ligseg @resnum H138 .or. -
   atom @ligseg @resnum C139 .or. -
   atom @ligseg @resnum H140 .or. -
   atom @ligseg @resnum H141 .or. -
   atom @ligseg @resnum C142 .or. -
   atom @ligseg @resnum H143 .or. -
   atom @ligseg @resnum H144 .or. -
   atom @ligseg @resnum C145 .or. -
   atom @ligseg @resnum H146 .or. -
   atom @ligseg @resnum H147 .or. -
   atom @ligseg @resnum C148 .or. -
   atom @ligseg @resnum H149 .or. -
   atom @ligseg @resnum H150 .or. -
   atom @ligseg @resnum C151 .or. -
   atom @ligseg @resnum H152 .or. -
   atom @ligseg @resnum H153 .or. -
   atom @ligseg @resnum O154 .or. -
   none ) end

auto angle dihe  !! do not call after deleting sub-sub terms or loading in water
bomblev -1

! delete angles and dihedrals between alchem groups
set ii = 1
label deletesiteloop
if @ii .le. @nsites then

   set jj = 1
   label delete1loop
   if @jj .le. @nsubs@@ii then

      calc kk = @jj + 1
      label delete2loop
      if @kk .le. @nsubs@@ii then

         dele connectivity sele ( site@{ii}_sub@@jj ) show end sele ( site@{ii}_sub@@kk ) show end
         calc kk = @kk + 1
         goto delete2loop
      endif

      calc jj = @jj + 1
      goto delete1loop
   endif

   calc ii = @ii + 1
   goto deletesiteloop
endif

!! ! System specific deletion (linear groups)
!! dele dihe sele (atom LIG 1 ATOMNAME) show end

!! coor orient

!! Load solvent
read sequ pdb name @builddir/solvent.pdb
generate WT00 first none last none setup noangl nodihe
read coor pdb resid name @builddir/solvent.pdb

!! !! Load ions
!! read sequ pdb name @builddir/ions.pdb
!! generate HETA first none last none setup noangl nodihe
!! read coor pdb resid name @builddir/ions.pdb

print coor sele .not. init end

bomblev 0

!! !! Write Initial System to Disk
!! write psf card name patch.psf
!! * patch psf file
!! *
!! write coor pdb card name patch.pdb
!! * patch pdb file
!! *
!! write coor card name patch.crd
!! * patch crd file
!! *

!! Create water box & periodic images
coor stat
crystal define cubic @box @box @box 90. 90. 90.
crystal build cutoff 14 nope 0
image byres xcen 0 ycen 0 zcen 0 sele resn tip3 .or. resn sod .or. resn pot .or. resn cla end
image byseg xcen 0 ycen 0 zcen 0 sele .not. ( resn tip3 .or. resn sod .or. resn pot .or. resn cla ) end

!! Copy main coords into comp set
cons harm clear
coor copy comp

! LDBI math: for every "pair" there are 5 ldbi's
set ii = 1
set ldbibias = 0
label ldbimathloop
if @ii .le. @nsites then
   calc ldbibias = @ldbibias + ( ( @nsubs@@ii * (@nsubs@@ii - 1) / 2 ) * 5 )
   INCR ii by 1
   goto ldbimathloop
endif
set charge = ?cgtot

calc blockplusone = @nblocks + 1

!! BLOCK setup
BLOCK @blockplusone
   clear
END
BLOCK @blockplusone !RX! NREP @nreps
   Call 2 sele site1_sub1 show end
   Call 3 sele site1_sub2 show end
   Call 4 sele site1_sub3 show end
   Call 5 sele site1_sub4 show end
   Call 6 sele site1_sub5 show end
   Call 7 sele site1_sub6 show end
   Call 8 sele site1_sub7 show end
   Call 9 sele site1_sub8 show end
   Call 10 sele site1_sub9 show end
   Call 11 sele site1_sub10 show end

   qldm theta
   lang temp @temp
   !RX! phmd ph 7
   soft on   ! this turns on soft-cores
   pmel ex   ! this turns on PME

   ldin 1 1.0  0.0  5.0  0.0  5.0
   ldin 2  0.1000 0.0  5.0  @lams1s1 5.0 !RX! NONE
   ldin 3  0.1000 0.0  5.0  @lams1s2 5.0 !RX! UNEG 7.0
   ldin 4  0.1000 0.0  5.0  @lams1s3 5.0 !RX! UPOS 7.0
   ldin 5  0.1000 0.0  5.0  @lams1s4 5.0 !RX! UNEG 7.0
   ldin 6  0.1000 0.0  5.0  @lams1s5 5.0 !RX! UPOS 7.0
   ldin 7  0.1000 0.0  5.0  @lams1s6 5.0 !RX! UNEG 7.0
   ldin 8  0.1000 0.0  5.0  @lams1s7 5.0 !RX! UPOS 7.0
   ldin 9  0.1000 0.0  5.0  @lams1s8 5.0 !RX! UNEG 7.0
   ldin 10 0.1000 0.0  5.0  @lams1s9 5.0 !RX! UPOS 7.0
   ldin 11 0.1000 0.0  5.0  @lams1s10 5.0 !RX! UNEG 7.0

   set excl1 = 2 3 2 4 2 5 2 6 2 7 2 8 2 9 2 10 2 11 3 4 3 5
   set excl2 = 3 6 3 7 3 8 3 9 3 10 3 11 4 5 4 6 4 7 4 8 4 9
   set excl3 = 4 10 4 11 5 6 5 7 5 8 5 9 5 10 5 11 6 7 6 8 6 9
   set excl4 = 6 10 6 11 7 8 7 9 7 10 7 11 8 9 8 10 8 11 9 10 9 11
   set excl5 = 10 11
   excl @excl1 @excl2 @excl3 @excl4 @excl5

   !!rmla bond thet dihe impr 
   rmla bond thet impr 
   msld 0  1  1  1  1  1  1  1  1  1  1  fnex @fnex
   msma

   ! Check block.doc for functional form of these biasing potentials
   calc nbiaspot = 5 * ( @nblocks * ( @nblocks - 1 ) ) / 2
   ldbi @nbiaspot
   set ibias = 1
   set iblock = 0
   set si = 1
   label loop5_vb
   if @si .le. @nsites then
      set jblock = @iblock
      set sj = @si
      label loop5b_vb
      if @sj .le. @nsites then
         set ii = 1
         label loop6_vb
         if @ii .le. @nsubs@@{si} then
            calc ip1 = @ii + 1 + @iblock
            set jj = 1
            if @si .eq. @sj then
               calc jj = @ii + 1
            endif
            label loop7_vb
            if @jj .le. @nsubs@@{sj} then
               calc jp1 = @jj + 1 + @jblock
   
               set c_shift = 0.0
               set x_shift = 0.0
               set s_shift = 0.0
               !vbrex! if @si .eq. @sj then
               !vbrex!    calc c_shift = 1.2 * (@myrep - @ncentral)
               !vbrex!    calc s_shift = 0.3 * (@myrep - @ncentral)
               !vbrex! endif
   
               calc coeff = @cs@@{si}s@@{ii}s@@{sj}s@@{jj} + @{c_shift}
               ldbv @ibias @ip1 @jp1 6 0.0 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @xs@@{si}s@@{ii}s@@{sj}s@@{jj} + @{x_shift}
               ldbv @ibias @ip1 @jp1 10 -5.56 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @ss@@{si}s@@{ii}s@@{sj}s@@{jj} + @{s_shift}
               ldbv @ibias @ip1 @jp1 8 0.017 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @xs@@{sj}s@@{jj}s@@{si}s@@{ii} + @{x_shift}
               ldbv @ibias @jp1 @ip1 10 -5.56 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @ss@@{sj}s@@{jj}s@@{si}s@@{ii} + @{s_shift}
               ldbv @ibias @jp1 @ip1 8 0.017 @coeff 0
               calc ibias = @ibias + 1
               calc jj = @jj + 1
               goto loop7_vb
            endif
            calc ii = @ii + 1
            goto loop6_vb
         endif
         calc jblock = @jblock + @nsubs@@{sj}
         calc sj = @sj + 1
         goto loop5b_vb
      endif
      calc iblock = @iblock + @nsubs@@{si}
      calc si = @si + 1
      goto loop5_vb
   endif
END

!! !! Set NOE distance restraints
!! NOE
!!    RESET
!! END
!! 
!! faster on
!! !! set up energy parameters if you want to use NOEs
!! nbonds atom fswitch vdw vfswitch cdie eps 1 -
!!     cutnb 14.0 cutim 14.0 ctonnb 10.0 ctofnb 12.0

!! energy
!! NOE
!! ! Site 1
!!    assign sele atom LIG 1 Atom1 end sele atom LIG 1 Atom2 end -
!!    kmin 1.0 rmin 0.0 kmax 1.0 rmax 0.2 fmax 2.0 rswitch 2.0 sexp 1.0
!! 
!!    print anal
!! END


